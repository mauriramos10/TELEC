<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ELECTRICIDAD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- jsQR for QR decoding -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
  <style>
    /* Fallback styles if your project doesn't define .btn/.secondary */
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#fff; font-size:14px; }
    .btn.secondary { background:#fff; color:#0f172a; }
    .btn.primary { background:#4f46e5; color:#fff; border-color:#4f46e5; }
    .btn.active { background:#4f46e5; color:#fff; border-color:#4f46e5; }
    .card { box-shadow: 0 10px 30px rgba(2,6,23,.06); }
    .muted { color:#64748b; }
    .pill { border:1px solid #cbd5e1; padding:.125rem .5rem; border-radius:9999px; font-size:12px; }
    .pill.ok { background:#e0f2fe; border-color:#7dd3fc; }
    .pill.err { background:#fee2e2; border-color:#fecaca; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <!-- Encabezado / HERO -->
  <section class="max-w-6xl mx-auto p-3 md:p-6">
    <div class="card bg-white rounded-2xl p-5 md:p-7 flex items-center gap-4 md:gap-8">
      <div class="flex items-center gap-3 shrink-0">
        <svg width="40" height="40" viewBox="0 0 24 24" class="text-orange-500" fill="currentColor" aria-hidden="true">
          <g transform="translate(12,12)">
            <circle r="3"></circle>
            <g stroke="currentColor" stroke-width="2" fill="none">
              <line x1="0" y1="-11" x2="0" y2="-6" />
              <line x1="0" y1="6" x2="0" y2="11" />
              <line x1="-11" y1="0" x2="-6" y2="0" />
              <line x1="6" y1="0" x2="11" y2="0" />
              <line x1="8" y1="8" x2="5" y2="5" />
              <line x1="-8" y1="-8" x2="-5" y2="-5" />
              <line x1="-8" y1="8" x2="-5" y2="5" />
              <line x1="8" y1="-8" x2="5" y2="-5" />
            </g>
          </g>
        </svg>
        <div class="leading-tight">
          <div class="text-slate-700 font-medium">Pantaleon</div>
        </div>
      </div>
      <div class="text-center grow">
        <div class="text-lg md:text-xl font-semibold">ELECTRICIDAD</div>
        <div class="muted text-sm">Área</div>
      </div>
      <div class="text-right shrink-0 leading-tight">
        <div class="font-semibold" id="clock">--:--:--</div>
        <div class="muted text-sm" id="dateLabel">—</div>
        <div class="muted text-xs">Responsable: <span class="font-medium lowercase">mauricio ramos</span></div>
      </div>
    </div>
    <div class="text-center muted text-sm mt-2">Ingenio Pantaleon · Ubicación: Guatemala</div>
  </section>

  <main class="max-w-6xl mx-auto p-3 md:p-6 space-y-6">
    <!-- SELECCIONE EQUIPO -->
    <section class="bg-white rounded-2xl border card p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-3">SELECCIONE EQUIPO</h2>
      <div id="equiposToolbar" class="flex flex-wrap gap-2">
        <button type="button" class="btn secondary" data-eq="MOTOR ELECTRICO">MOTOR ELECTRICO</button>
        <button type="button" class="btn secondary" data-eq="TRANSFORMADOR">TRANSFORMADOR</button>
        <button type="button" class="btn secondary" data-eq="AIRE ACONDICIONADO">AIRE ACONDICIONADO</button>
        <button type="button" class="btn secondary" data-eq="VARIADOR DE FRECUENCIA">VARIADOR DE FRECUENCIA</button>
        <button type="button" class="btn secondary" data-eq="ARRANCADOR DIRECTO/SUAVE">ARRANCADOR DIRECTO/SUAVE</button>
        <button type="button" class="btn secondary" data-eq="MANEJADORA DE AIRE">MANEJADORA DE AIRE</button>
        <button type="button" class="btn secondary" data-eq="CHILLER">CHILLER</button>
      </div>
    </section>

    <!-- DESCRIPCIÓN DEL EQUIPO -->
    <section class="bg-white rounded-2xl border card p-4 md:p-6">
      <h2 class="text-lg font-semibold mb-3">DESCRIPCIÓN DEL EQUIPO</h2>
      <div id="descEquipo" class="text-sm text-slate-700">
        Selecciona un tipo de equipo para ver su descripción.
      </div>
    </section>

    <!-- ESCANEAR CÓDIGO QR (ASCII) -->
    <section class="bg-white rounded-2xl border card p-4 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">ESCANEAR CÓDIGO QR</h2>
        <span id="qrStatus" class="pill">Listo</span>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
        <!-- Vista previa de la cámara -->
        <div>
          <div class="rounded-xl overflow-hidden border bg-black relative">
            <video id="qrVideo" autoplay playsinline muted class="w-full h-[280px] object-cover"></video>
            <!-- Marco guía -->
            <div class="absolute inset-0 pointer-events-none grid place-items-center">
              <div class="w-40 h-40 border-2 border-white/70 rounded-lg"></div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 mt-3">
            <button id="btnStart" class="btn primary">Iniciar cámara</button>
            <button id="btnStop" class="btn secondary">Detener</button>
            <label class="btn secondary cursor-pointer">
              Subir imagen
              <input id="fileQR" type="file" accept="image/*" class="hidden" />
            </label>
          </div>
          <p class="text-xs muted mt-2">En móviles, la cámara trasera suele dar mejores resultados.</p>
        </div>

        <!-- Resultado ASCII -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Código ASCII detectado</label>
          <textarea id="qrAscii" rows="8" class="w-full border rounded-xl p-3 text-sm" placeholder="Aún no se ha detectado ningún QR... (aparecerán números separados por espacios)" ></textarea>
          <div class="flex gap-2 mt-2">
            <button id="btnCopy" class="btn secondary">Copiar ASCII</button>
            <button id="btnClearQR" class="btn secondary">Limpiar</button>
          </div>
        </div>
      </div>
      <!-- Canvas oculto para procesar frames -->
      <canvas id="qrCanvas" class="hidden"></canvas>
    </section>
  </main>

  <script>
    // Reloj/fecha
    const clockEl = document.getElementById("clock");
    const dateEl = document.getElementById("dateLabel");
    function updateClock(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      clockEl.textContent = `${hh}:${mm}:${ss}`;
      const fmt = new Intl.DateTimeFormat("es-ES", { weekday:"long", day:"2-digit", month:"long", year:"numeric" });
      const txt = fmt.format(now);
      dateEl.textContent = txt.charAt(0).toUpperCase() + txt.slice(1);
    }
    updateClock(); setInterval(updateClock, 1000);

    // Descripciones por equipo
    const MAP = {
      "MOTOR ELECTRICO": [
        "Número de rodamiento lado acople",
        "Número de rodamiento lado ventilador"
      ],
      "VARIADOR DE FRECUENCIA": [
        "Serie del VDF",
        "Marca del VDF",
        "Potencia (HP)"
      ]
    };

    const tb = document.getElementById("equiposToolbar");
    const desc = document.getElementById("descEquipo");

    function setDesc(lines){
      if(!lines || !lines.length){
        desc.innerHTML = "<span class='text-slate-500'>No hay descripción definida para este tipo. Indícame los campos y la agrego.</span>";
        return;
      }
      const ul = document.createElement("ul");
      ul.className = "list-disc pl-6";
      lines.forEach(t => { const li=document.createElement("li"); li.textContent=t; ul.appendChild(li); });
      desc.innerHTML = "";
      desc.appendChild(ul);
    }

    tb.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-eq]");
      if(!btn) return;
      tb.querySelectorAll("button[data-eq]").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      setDesc(MAP[btn.dataset.eq]);
    });

    // Selección inicial: activa MOTOR ELECTRICO
    const first = tb.querySelector('button[data-eq="MOTOR ELECTRICO"]');
    if(first){ first.click(); }

    // ---- QR SCAN to ASCII ----
    const video = document.getElementById("qrVideo");
    const canvas = document.getElementById("qrCanvas");
    const ctx = canvas.getContext("2d");
    const txtArea = document.getElementById("qrAscii");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const fileQR = document.getElementById("fileQR");
    const statusEl = document.getElementById("qrStatus");
    const btnCopy = document.getElementById("btnCopy");
    const btnClearQR = document.getElementById("btnClearQR");

    let stream = null;
    let rafId = null;

    function setStatus(msg, ok=false, err=false){
      statusEl.textContent = msg;
      statusEl.classList.remove("ok","err");
      if(ok) statusEl.classList.add("ok");
      if(err) statusEl.classList.add("err");
    }

    async function startCamera(){
      try{
        // Try rear camera first
        const constraints = {
          video: { facingMode: { ideal: "environment" } },
          audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        await video.play();
        setStatus("Cámara activa", true, false);
        scanLoop();
      }catch(e){
        console.error(e);
        setStatus("No se pudo iniciar la cámara", false, true);
      }
    }

    function stopCamera(){
      if(rafId) cancelAnimationFrame(rafId);
      rafId = null;
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      setStatus("Cámara detenida");
    }

    function textToAsciiNumbers(text){
      return Array.from(text || "").map(ch => ch.charCodeAt(0)).join(" ");
    }

    function scanOnce(){
      const w = video.videoWidth, h = video.videoHeight;
      if(!w || !h) return;
      canvas.width = w; canvas.height = h;
      ctx.drawImage(video, 0, 0, w, h);
      const imageData = ctx.getImageData(0, 0, w, h);
      const result = jsQR(imageData.data, w, h, { inversionAttempts: "dontInvert" });
      if(result && result.data){
        txtArea.value = textToAsciiNumbers(result.data);
        setStatus("Código detectado", true, false);
      }
    }

    function scanLoop(){
      scanOnce();
      rafId = requestAnimationFrame(scanLoop);
    }

    // Upload still image to decode
    fileQR.addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const img = new Image();
      img.onload = () => {
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const result = jsQR(imageData.data, canvas.width, canvas.height);
        if(result && result.data){
          txtArea.value = textToAsciiNumbers(result.data);
          setStatus("Código detectado (imagen)", true, false);
        }else{
          setStatus("No se detectó QR en la imagen", false, true);
        }
      };
      img.onerror = () => setStatus("No se pudo leer la imagen", false, true);
      const reader = new FileReader();
      reader.onload = ev => { img.src = ev.target.result; };
      reader.readAsDataURL(file);
    });

    btnStart.addEventListener("click", startCamera);
    btnStop.addEventListener("click", stopCamera);

    btnCopy.addEventListener("click", ()=>{
      txtArea.select();
      document.execCommand("copy");
      setStatus("ASCII copiado", true, false);
    });

    btnClearQR.addEventListener("click", ()=>{
      txtArea.value = "";
      setStatus("Listo");
    });
  </script>
</body>
</html>
