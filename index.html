<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TELEC — Equipos (BN selector)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .app-bg { background: radial-gradient(1200px 400px at 50% -50%, rgba(0,0,0,0.04), transparent 70%); }
    .card { box-shadow: 0 10px 30px rgba(2,6,23,.06); }
    .muted { color: #64748b; }
    .dropzone { border: 2px dashed #cbd5e1; border-radius: 1rem; padding: 1rem; text-align: center; transition: background .2s; }
    .dropzone.dragover { background: #f1f5f9; }
    .kv { display:grid; grid-template-columns: 220px 1fr; gap:.5rem 1rem; }
    @media (max-width: 640px){ .kv { grid-template-columns: 1fr; } }
    .list { max-height: 420px; overflow:auto; }
    .item { cursor:pointer; padding:.5rem .75rem; border-radius:.75rem; }
    .item:hover { background:#f1f5f9; }
    .item.active { background:#e0e7ff; }
  </style>
</head>
<body class="app-bg min-h-screen text-slate-900">
  <!-- Encabezado tipo imagen -->
  <section class="max-w-6xl mx-auto p-3 md:p-6">
    <div class="card bg-white rounded-2xl p-5 md:p-7 flex items-center gap-4 md:gap-8">
      <div class="flex items-center gap-3 shrink-0">
        <svg width="40" height="40" viewBox="0 0 24 24" class="text-orange-500" fill="currentColor" aria-hidden="true">
          <g transform="translate(12,12)">
            <circle r="3"></circle>
            <g stroke="currentColor" stroke-width="2" fill="none">
              <line x1="0" y1="-11" x2="0" y2="-6" />
              <line x1="0" y1="6" x2="0" y2="11" />
              <line x1="-11" y1="0" x2="-6" y2="0" />
              <line x1="6" y1="0" x2="11" y2="0" />
              <line x1="8" y1="8" x2="5" y2="5" />
              <line x1="-8" y1="-8" x2="-5" y2="-5" />
              <line x1="-8" y1="8" x2="-5" y2="5" />
              <line x1="8" y1="-8" x2="5" y2="-5" />
            </g>
          </g>
        </svg>
        <div class="leading-tight"><div class="text-slate-700 font-medium">Pantaleon</div></div>
      </div>
      <div class="text-center grow">
        <div class="text-lg md:text-xl font-semibold">Extracción de Jugo</div>
        <div class="muted text-sm">Área</div>
      </div>
      <div class="text-right shrink-0 leading-tight">
        <div class="font-semibold" id="clock">--:--:--</div>
        <div class="muted text-sm" id="dateLabel">—</div>
        <div class="muted text-xs">Responsable: <span class="font-medium lowercase">mauricio ramos</span></div>
      </div>
    </div>
    <div class="text-center muted text-sm mt-2">Ingenio Pantaleon · Ubicación: Guatemala</div>
  </section>

  <main class="max-w-6xl mx-auto p-3 md:p-6 space-y-6">
    <!-- Carga -->
    <section class="bg-white rounded-2xl card p-4 md:p-6">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700">Cargar Excel (se usará F..EG)</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="mt-1 w-full border rounded-xl px-3 py-2" />
          <p class="text-xs muted mt-1">Se procesa localmente en tu navegador.</p>
        </div>
        <div>
          <div id="drop" class="dropzone">Arrastra y suelta aquí tu Excel<br><span class="text-xs muted">(o usa el selector de archivos)</span></div>
          <p id="loadInfo" class="text-xs muted mt-2">Sin datos cargados</p>
        </div>
      </div>
    </section>

    <!-- Buscador por columna BN + Detalle MOTOR -->
    <section class="bg-white rounded-2xl card p-4 md:p-6">
      <div class="grid md:grid-cols-3 gap-6">
        <!-- Columna izquierda: buscador por BN y lista -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium text-slate-700">Buscar por <b>columna BN</b></label>
          <input id="q" type="search" placeholder="Escribe parte del valor BN..." class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <div id="list" class="list mt-3 border rounded-xl p-2"></div>
        </div>

        <!-- Columna derecha: detalle MOTOR -->
        <div class="md:col-span-2">
          <div class="rounded-2xl border p-4 md:p-6">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-lg md:text-xl font-bold">MOTOR</div>
                <div class="muted text-sm">Detalle del equipo seleccionado (F..EG)</div>
              </div>
              <button id="btnExport" class="bg-indigo-600 text-white rounded-xl px-3 py-2 hover:bg-indigo-700" disabled>Exportar CSV (equipo)</button>
            </div>
            <div id="selectedKey" class="mt-2 text-sm"></div>
            <div id="detail" class="mt-4 kv"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // Reloj/fecha
    const clockEl = document.getElementById("clock");
    const dateEl = document.getElementById("dateLabel");
    function updateClock(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      clockEl.textContent = `${hh}:${mm}:${ss}`;
      const fmt = new Intl.DateTimeFormat("es-ES", { weekday:"long", day:"2-digit", month:"long", year:"numeric" });
      const txt = fmt.format(now);
      dateEl.textContent = txt.charAt(0).toUpperCase() + txt.slice(1);
    }
    updateClock(); setInterval(updateClock, 1000);

    // Utilidades
    function colLetterToIndex(col){ // 0-based
      let n=0;
      for (let i=0;i<col.length;i++){ n = n*26 + (col.charCodeAt(i)-64); }
      return n-1;
    }
    const START_COL = colLetterToIndex("F");   // inclusive
    const END_COL   = colLetterToIndex("EG");  // inclusive
    const BN_INDEX  = colLetterToIndex("BN");  // absoluta en hoja
    function norm(s){ return (s==null?"":String(s)).normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase(); }

    // Estado
    let headers = [];           // F..EG (nombres)
    let rows = [];              // Objetos por fila: {header:value, ...}
    let bnList = [];            // [{key, rowObj}] - key es el valor BN de esa fila
    let current = null;         // equipo seleccionado (obj)

    // DOM
    const $file = document.getElementById("fileInput");
    const $drop = document.getElementById("drop");
    const $loadInfo = document.getElementById("loadInfo");
    const $q = document.getElementById("q");
    const $list = document.getElementById("list");
    const $detail = document.getElementById("detail");
    const $selectedKey = document.getElementById("selectedKey");
    const $btnExport = document.getElementById("btnExport");

    function readFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
        if (!aoa.length) { $loadInfo.textContent="Hoja vacía"; return; }

        const hdrRow = aoa[0];
        headers = hdrRow.slice(START_COL, END_COL+1).map(h => String(h||"").trim());
        headers = headers.map((h,i)=> h || `Col_${i+START_COL+1}`);

        rows = [];
        bnList = [];
        for (let r=1; r<aoa.length; r++){
          const rowFull = aoa[r];
          const bnVal = String(rowFull[BN_INDEX] ?? "").trim();
          // Tomar F..EG de esa fila y eliminar vacíos
          const slice = rowFull.slice(START_COL, END_COL+1);
          const obj = {};
          headers.forEach((h,idx)=>{
            const val = slice[idx];
            if (String(val||"").trim() !== "") obj[h] = val;
          });
          // Solo consideramos equipos que tengan algún dato y BN tenga algo
          if (bnVal && Object.keys(obj).length){
            rows.push(obj);
            bnList.push({ key: bnVal, data: obj });
          }
        }

        $loadInfo.textContent = `Hoja: ${sheetName} — Equipos con BN: ${bnList.length}`;
        $btnExport.disabled = true;
        renderList();
        if (bnList.length){
          selectItem(0); // seleccionar el primero
        } else {
          $detail.innerHTML = "";
          $selectedKey.textContent = "";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function renderList(filter=""){
      const f = norm(filter);
      const matches = bnList
        .map((it, idx)=> ({...it, idx}))
        .filter(it => !f || norm(it.key).includes(f))
        .slice(0, 500); // cap

      $list.innerHTML = "";
      if (!matches.length){
        $list.innerHTML = `<div class="muted text-sm p-2">Sin coincidencias para “${filter}”.</div>`;
        return;
      }
      matches.forEach((it) => {
        const div = document.createElement("div");
        div.className = "item";
        div.textContent = it.key;
        div.dataset.idx = it.idx;
        div.addEventListener("click", () => selectItem(it.idx));
        $list.appendChild(div);
      });
      markActive();
    }

    function markActive(){
      const items = $list.querySelectorAll(".item");
      items.forEach(el => {
        if (current && el.dataset.idx == current.__idx) el.classList.add("active");
        else el.classList.remove("active");
      });
    }

    function selectItem(idx){
      const entry = bnList[idx];
      current = { __idx: idx, key: entry.key, data: entry.data };
      $selectedKey.textContent = `BN: ${current.key}`;
      // Render detail key-values
      const keys = Object.keys(current.data);
      const kv = keys.map(k => `<div class="muted">${k}</div><div>${current.data[k]}</div>`).join("");
      $detail.innerHTML = kv || `<div class="muted">Sin campos con valor para este equipo.</div>`;
      $btnExport.disabled = false;
      markActive();
      // Asegurar que el item activo esté visible
      const active = $list.querySelector(`.item[data-idx="${idx}"]`);
      if (active) active.scrollIntoView({block:"nearest"});
    }

    // Exportar CSV del equipo seleccionado
    function exportCurrent(){
      if (!current) return;
      const cols = Object.keys(current.data);
      const esc = v => {
        if (v==null) return "";
        const s = String(v).replace(/"/g,'""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      };
      const header = cols.join(",");
      const line = cols.map(c => esc(current.data[c])).join(",");
      const csv = [header, line].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = `equipo_${current.key}.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    // Eventos
    document.getElementById("fileInput").addEventListener("change", e => { const f=e.target.files[0]; if(f) readFile(f); });
    ["dragenter","dragover"].forEach(ev=> $drop.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add("dragover"); }));
    ["dragleave","drop"].forEach(ev=> $drop.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove("dragover"); }));
    $drop.addEventListener("drop",e=>{ if(e.dataTransfer.files && e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]); });

    document.getElementById("q").addEventListener("input", e => renderList(e.target.value));
    document.getElementById("btnExport").addEventListener("click", exportCurrent);
  </script>
</body>
</html>
