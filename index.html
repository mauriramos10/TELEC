<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TELEC — Equipos (F..EG)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .app-bg { background: radial-gradient(1200px 400px at 50% -50%, rgba(0,0,0,0.04), transparent 70%); }
    .card { box-shadow: 0 10px 30px rgba(2,6,23,.06); }
    .muted { color: #64748b; }
    .sticky-th th { position: sticky; top: 0; background: #f8fafc; z-index: 1; }
    .scroll-x { overflow-x: auto; }
    .dropzone { border: 2px dashed #cbd5e1; border-radius: 1rem; padding: 1rem; text-align: center; transition: background .2s; }
    .dropzone.dragover { background: #f1f5f9; }
    .kv { display:grid; grid-template-columns: 220px 1fr; gap:.5rem 1rem; }
    @media (max-width: 640px){ .kv { grid-template-columns: 1fr; } }
  </style>
</head>
<body class="app-bg min-h-screen text-slate-900">
  <!-- Encabezado como tu imagen -->
  <section class="max-w-6xl mx-auto p-3 md:p-6">
    <div class="card bg-white rounded-2xl p-5 md:p-7 flex items-center gap-4 md:gap-8">
      <div class="flex items-center gap-3 shrink-0">
        <svg width="40" height="40" viewBox="0 0 24 24" class="text-orange-500" fill="currentColor" aria-hidden="true">
          <g transform="translate(12,12)">
            <circle r="3"></circle>
            <g stroke="currentColor" stroke-width="2" fill="none">
              <line x1="0" y1="-11" x2="0" y2="-6" />
              <line x1="0" y1="6" x2="0" y2="11" />
              <line x1="-11" y1="0" x2="-6" y2="0" />
              <line x1="6" y1="0" x2="11" y2="0" />
              <line x1="8" y1="8" x2="5" y2="5" />
              <line x1="-8" y1="-8" x2="-5" y2="-5" />
              <line x1="-8" y1="8" x2="-5" y2="5" />
              <line x1="8" y1="-8" x2="5" y2="-5" />
            </g>
          </g>
        </svg>
        <div class="leading-tight">
          <div class="text-slate-700 font-medium">Pantaleon</div>
        </div>
      </div>
      <div class="text-center grow">
        <div class="text-lg md:text-xl font-semibold">Extracción de Jugo</div>
        <div class="muted text-sm">Área</div>
      </div>
      <div class="text-right shrink-0 leading-tight">
        <div class="font-semibold" id="clock">--:--:--</div>
        <div class="muted text-sm" id="dateLabel">—</div>
        <div class="muted text-xs">Responsable: <span class="font-medium lowercase">mauricio ramos</span></div>
      </div>
    </div>
    <div class="text-center muted text-sm mt-2">Ingenio Pantaleon · Ubicación: Guatemala</div>
  </section>

  <main class="max-w-6xl mx-auto p-3 md:p-6 space-y-6">
    <!-- Carga de Excel -->
    <section class="bg-white rounded-2xl card p-4 md:p-6">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700">Cargar Excel (se usará solo F..EG)</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="mt-1 w-full border rounded-xl px-3 py-2" />
          <p class="text-xs muted mt-1">Se procesa localmente en tu navegador.</p>
        </div>
        <div>
          <div id="drop" class="dropzone">Arrastra y suelta aquí tu Excel<br><span class="text-xs muted">(o usa el selector de archivos)</span></div>
          <p id="loadInfo" class="text-xs muted mt-2">Sin datos cargados</p>
        </div>
      </div>
    </section>

    <!-- Controles -->
    <section class="bg-white rounded-2xl card p-4 md:p-6">
      <div class="grid md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium text-slate-700">Buscar en campos (F..EG)</label>
          <input id="q" type="search" placeholder="Equipo, descripción, etc." class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div class="flex gap-2">
          <button id="btnClear" class="grow border rounded-xl px-3 py-2 hover:bg-slate-50">Limpiar</button>
          <button id="btnExport" class="grow bg-indigo-600 text-white rounded-xl px-3 py-2 hover:bg-indigo-700" disabled>Exportar CSV</button>
        </div>
        <div class="text-right muted text-sm">Equipos mostrados: <span id="countShown">0</span></div>
      </div>
    </section>

    <!-- Lista de equipos (solo campos con valor) -->
    <section id="cards" class="space-y-3"></section>
  </main>

  <script>
    // Reloj/fecha
    const clockEl = document.getElementById("clock");
    const dateEl = document.getElementById("dateLabel");
    function updateClock(){
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,"0");
      const mm = String(now.getMinutes()).padStart(2,"0");
      const ss = String(now.getSeconds()).padStart(2,"0");
      clockEl.textContent = `${hh}:${mm}:${ss}`;
      const fmt = new Intl.DateTimeFormat("es-ES", { weekday:"long", day:"2-digit", month:"long", year:"numeric" });
      const txt = fmt.format(now);
      dateEl.textContent = txt.charAt(0).toUpperCase() + txt.slice(1);
    }
    updateClock(); setInterval(updateClock, 1000);

    // Utilidades
    function colLetterToIndex(col){ // 0-based
      let n=0;
      for (let i=0;i<col.length;i++){ n = n*26 + (col.charCodeAt(i)-64); }
      return n-1;
    }
    const START_COL = colLetterToIndex("F");  // inclusive
    const END_COL   = colLetterToIndex("EG"); // inclusive

    function norm(s){ return (s==null?"":String(s)).normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase(); }

    // Estado
    let headers = [];
    let rows = []; // [{header:value,...}, ...] solo F..EG
    let filtered = [];

    // DOM
    const $file = document.getElementById("fileInput");
    const $drop = document.getElementById("drop");
    const $loadInfo = document.getElementById("loadInfo");
    const $q = document.getElementById("q");
    const $btnClear = document.getElementById("btnClear");
    const $btnExport = document.getElementById("btnExport");
    const $cards = document.getElementById("cards");
    const $countShown = document.getElementById("countShown");

    function readFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type:"array"});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        // Matriz cruda
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
        if (!aoa.length) { $loadInfo.textContent="Hoja vacía"; return; }

        // Tomar encabezados y datos dentro del rango F..EG
        const hdrRow = aoa[0];
        headers = hdrRow.slice(START_COL, END_COL+1).map(h => String(h||"").trim());
        // Si algún encabezado viene vacío, genera uno genérico (Col_F, Col_G, etc.)
        headers = headers.map((h,i)=> h || `Col_${i+START_COL+1}`);

        rows = [];
        for (let r=1; r<aoa.length; r++){
          const slice = aoa[r].slice(START_COL, END_COL+1);
          // ¿Tiene algún valor?
          const hasValue = slice.some(v => String(v||"").trim() !== "");
          if (!hasValue) continue;
          // Construir objeto solo con campos no vacíos
          const obj = {};
          headers.forEach((h,idx)=>{
            const val = slice[idx];
            if (String(val||"").trim() !== "") obj[h] = val;
          });
          // Si después de quitar vacíos quedó sin claves, saltar
          if (Object.keys(obj).length === 0) continue;
          rows.push(obj);
        }

        $loadInfo.textContent = `Hoja: ${sheetName} — Equipos cargados (F..EG): ${rows.length}`;
        $btnExport.disabled = rows.length===0;
        applyFilter();
      };
      reader.readAsArrayBuffer(file);
    }

    function applyFilter(){
      const q = norm($q.value);
      filtered = rows.filter(obj => {
        if (!q) return true;
        return Object.values(obj).some(v => norm(v).includes(q));
      });
      renderCards();
      $countShown.textContent = filtered.length;
    }

    function renderCards(){
      $cards.innerHTML = "";
      if (!filtered.length){
        $cards.innerHTML = `<div class="text-center muted">No hay resultados con el criterio actual.</div>`;
        return;
      }
      // Heurística de título de tarjeta: busca campo 'Equipo' o 'Descripción'
      filtered.forEach((obj, idx) => {
        const keys = Object.keys(obj);
        const keyEquipo = keys.find(k => /equipo|asset|tag/i.test(k)) || keys.find(k => /descrip/i.test(k)) || keys[0];
        const titulo = String(obj[keyEquipo] ?? `Equipo ${idx+1}`);

        const kv = keys.map(k => `<div class="muted">${k}</div><div>${obj[k]}</div>`).join("");

        const card = document.createElement("div");
        card.className = "card bg-white rounded-2xl p-4 md:p-6";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-base md:text-lg font-semibold">${titulo}</div>
              <div class="mt-3 kv">${kv}</div>
            </div>
            <div class="text-sm muted">#${idx+1}</div>
          </div>
        `;
        $cards.appendChild(card);
      });
    }

    // Eventos
    $file.addEventListener("change", e => { const f=e.target.files[0]; if(f) readFile(f); });
    ["dragenter","dragover"].forEach(ev=> $drop.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add("dragover"); }));
    ["dragleave","drop"].forEach(ev=> $drop.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove("dragover"); }));
    $drop.addEventListener("drop",e=>{ if(e.dataTransfer.files && e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]); });

    $q.addEventListener("input", applyFilter);
    $btnClear.addEventListener("click", ()=>{ $q.value=""; applyFilter(); });

    // Exportar CSV (solo lo filtrado)
    function exportCSV(){
      const keys = new Set();
      filtered.forEach(obj => Object.keys(obj).forEach(k=>keys.add(k)));
      const cols = Array.from(keys);
      const esc = v => {
        if (v==null) return "";
        const s = String(v).replace(/"/g,'""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      };
      const header = cols.join(",");
      const lines = filtered.map(obj => cols.map(c => esc(obj[c])).join(","));
      const csv = [header, ...lines].join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "equipos_F_a_EG.csv"; a.click();
      URL.revokeObjectURL(url);
    }
    $btnExport.addEventListener("click", exportCSV);
  </script>
</body>
</html>
