<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TELEC — Avisos OT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS to read Excel on the client -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .fallback-container { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    .sticky-th th { position: sticky; top: 0; background: #f8fafc; z-index: 1; }
    .chip { display:inline-block; padding:2px 8px; border-radius:9999px; font-size:12px; background:#eef2ff; }
    .scroll-x { overflow-x:auto; }
    .dropzone { border: 2px dashed #cbd5e1; border-radius: 1rem; padding: 1.25rem; text-align: center; transition: background 0.2s; }
    .dropzone.dragover { background: #f1f5f9; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 fallback-container">
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">TELEC — Avisos OT</h1>
        <p class="text-sm text-slate-600">Panel de búsqueda y filtrado (encabezado conservado)</p>
      </div>
      <div class="text-right">
        <p class="text-xs text-slate-500">Fuente: Archivo Excel de avisos OT (cárgalo abajo)</p>
        <p id="loadInfo" class="text-xs text-slate-500">Sin datos cargados</p>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Carga de Excel -->
    <section class="bg-white shadow rounded-2xl p-4 md:p-6">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-slate-700">Cargar Excel (avisos_OT)</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls" class="mt-1 w-full border rounded-xl px-3 py-2" />
          <p class="text-xs text-slate-500 mt-1">Sugerido: “Avisos _ OT TELEC 1.xlsx”. Se lee totalmente en el navegador, sin subirlo a servidores.</p>
        </div>
        <div>
          <div id="drop" class="dropzone">
            Arrastra y suelta aquí tu Excel<br>
            <span class="text-xs text-slate-500">(o usa el selector de archivos)</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Filtros -->
    <section class="bg-white shadow rounded-2xl p-4 md:p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium text-slate-700">Búsqueda rápida</label>
          <input id="q" type="search" placeholder="Buscar en todas las columnas..." class="mt-1 w-full border rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Filtrar por columna</label>
          <select id="col" class="mt-1 w-full border rounded-xl px-3 py-2"></select>
        </div>
        <div class="flex gap-2">
          <button id="btnClear" class="grow border rounded-xl px-3 py-2 hover:bg-slate-50">Limpiar filtros</button>
          <button id="btnExport" class="grow bg-indigo-600 text-white rounded-xl px-3 py-2 hover:bg-indigo-700" disabled>Exportar CSV</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div id="valuesContainer" class="col-span-1 md:col-span-2"></div>
        <div>
          <label class="block text-sm font-medium text-slate-700">Rango de fechas <span id="dateColName" class="text-slate-400"></span></label>
          <div class="mt-1 grid grid-cols-2 gap-2">
            <input id="dateFrom" type="date" class="w-full border rounded-xl px-3 py-2" />
            <input id="dateTo" type="date" class="w-full border rounded-xl px-3 py-2" />
          </div>
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">El buscador acepta coincidencias parciales; los valores únicos se basan en la columna seleccionada.</p>
    </section>

    <section id="resumen" class="hidden bg-white shadow rounded-2xl p-4 md:p-6"></section>

    <!-- Tabla -->
    <section class="bg-white shadow rounded-2xl p-2 md:p-4">
      <div class="flex items-center justify-between px-2 py-2">
        <div class="text-sm text-slate-600">Mostrando <span id="countShown">0</span> de <span id="countTotal">0</span> registros</div>
        <div>
          <label class="text-sm text-slate-700">Filas por página:</label>
          <select id="pageSize" class="border rounded-lg px-2 py-1 ml-2">
            <option>10</option><option selected>25</option><option>50</option><option>100</option>
          </select>
        </div>
      </div>
      <div class="scroll-x">
        <table id="table" class="w-full text-left text-sm">
          <thead class="sticky-th"><tr id="thead" class="bg-slate-100"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-2 py-3">
        <button id="prev" class="border rounded-lg px-3 py-1 disabled:opacity-50">Anterior</button>
        <div class="text-sm">Página <span id="pageNum">1</span> / <span id="pageTotal">1</span></div>
        <button id="next" class="border rounded-lg px-3 py-1 disabled:opacity-50">Siguiente</button>
      </div>
    </section>

    <section class="bg-white shadow rounded-2xl p-4 md:p-6">
      <details>
        <summary class="cursor-pointer font-medium">Ayuda y notas</summary>
        <ul class="list-disc pl-6 mt-2 text-sm text-slate-700 space-y-1">
          <li>La carga del Excel es <b>local</b> (nunca se sube a Internet).</li>
          <li>Puedes reusar el mismo HTML con nuevos Excels sin cambiar el código.</li>
          <li>Si existe una columna llamada “Fecha…”, verás el filtro por rango.</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
    let COLUMNS = [];
    let rawData = [];
    let state = { q: "", col: "", values: new Set(), sortCol: "", sortDir: 1, page: 1, pageSize: 25 };

    const $file = document.getElementById("fileInput");
    const $drop = document.getElementById("drop");
    const $loadInfo = document.getElementById("loadInfo");
    const $q = document.getElementById("q");
    const $col = document.getElementById("col");
    const $valuesContainer = document.getElementById("valuesContainer");
    const $dateFrom = document.getElementById("dateFrom");
    const $dateTo = document.getElementById("dateTo");
    const $dateColName = document.getElementById("dateColName");
    const $btnClear = document.getElementById("btnClear");
    const $btnExport = document.getElementById("btnExport");
    const $thead = document.getElementById("thead");
    const $tbody = document.getElementById("tbody");
    const $countShown = document.getElementById("countShown");
    const $countTotal = document.getElementById("countTotal");
    const $pageSize = document.getElementById("pageSize");
    const $prev = document.getElementById("prev");
    const $next = document.getElementById("next");
    const $pageNum = document.getElementById("pageNum");
    const $pageTotal = document.getElementById("pageTotal");
    const $resumen = document.getElementById("resumen");

    function norm(s){ return (s==null?"":String(s)).normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase(); }
    function uniqueValues(col){ const s=new Set(); for(const r of rawData) s.add(String(r[col]??"")); return [...s].filter(v=>v!=="").sort(); }
    function detectDateCol(){ return COLUMNS.find(c=>/fecha/i.test(c)) || ""; }
    function parseDate(s){
      if(!s) return null;
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+"T00:00:00");
      const m=/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/.exec(s);
      if(m){const d=m[1].padStart(2,"0"), mo=m[2].padStart(2,"0"), y=m[3].padStart(4,"20"); return new Date(`${y}-${mo}-${d}T00:00:00`);}
      const d=new Date(s); return isNaN(d)?null:d;
    }

    function renderColumnSelect(){
      $col.innerHTML="";
      for(const c of COLUMNS){ const o=document.createElement("option"); o.value=c; o.textContent=c; $col.appendChild(o); }
      state.col = COLUMNS[0] || "";
      $col.value = state.col;
    }
    function renderValues(){
      const values=uniqueValues(state.col).slice(0,400), sel=state.values;
      const wrap=document.createElement("div");
      wrap.className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-56 overflow-auto border rounded-xl p-2";
      for(const v of values){
        const id="v_"+Math.random().toString(36).slice(2);
        const box=document.createElement("div"); box.className="flex items-center gap-2";
        box.innerHTML=`<input id="${id}" type="checkbox" class="h-4 w-4" ${(sel.has(v)?"checked":"")}>
                        <label for="${id}" class="text-sm"></label>`;
        box.querySelector("label").textContent=v;
        box.querySelector("input").addEventListener("change",e=>{ if(e.target.checked) sel.add(v); else sel.delete(v); state.page=1; render(); });
        wrap.appendChild(box);
      }
      $valuesContainer.innerHTML="";
      const label=document.createElement("div"); label.className="text-sm font-medium text-slate-700 mb-1"; label.textContent="Valores únicos de: "+(state.col||"-");
      $valuesContainer.appendChild(label);
      $valuesContainer.appendChild(wrap);
    }

    function applyFilters(rows){
      let out=rows;
      if(state.q.trim()!==""){ const qn=norm(state.q); out=out.filter(r=>COLUMNS.some(c=>norm(r[c]).includes(qn))); }
      if(state.values.size>0){ out=out.filter(r=>state.values.has(String(r[state.col]??""))); }
      const DATE_COL = detectDateCol();
      if(DATE_COL && ($dateFrom.value || $dateTo.value)){
        const from=$dateFrom.value?new Date($dateFrom.value+"T00:00:00"):null;
        const to=$dateTo.value?new Date($dateTo.value+"T23:59:59"):null;
        out=out.filter(r=>{ const d=parseDate(String(r[DATE_COL])); if(!d) return false; if(from&&d<from) return false; if(to&&d>to) return false; return true; });
      }
      return out;
    }
    function applySort(rows){
      if(!state.sortCol) return rows;
      const col=state.sortCol, dir=state.sortDir;
      return [...rows].sort((a,b)=>{
        const av=String(a[col]??""), bv=String(b[col]??"");
        const an=parseFloat(av.replace(",",".")), bn=parseFloat(bv.replace(",","."));
        const aNum=!isNaN(an)&&av.trim()!=="", bNum=!isNaN(bn)&&bv.trim()!=="";
        if(aNum&&bNum) return (an-bn)*dir;
        return av.localeCompare(bv,"es",{sensitivity:"base"})*dir;
      });
    }
    function renderTableHeader(){
      $thead.innerHTML="";
      for(const c of COLUMNS){
        const th=document.createElement("th"); th.className="px-3 py-2 border-b border-slate-200 whitespace-nowrap cursor-pointer select-none"; th.textContent=c;
        th.addEventListener("click",()=>{ if(state.sortCol===c) state.sortDir*=-1; else {state.sortCol=c; state.sortDir=1;} render(); });
        if(state.sortCol===c){ const s=document.createElement("span"); s.className="ml-1 text-slate-500"; s.textContent=state.sortDir>0?"▲":"▼"; th.appendChild(s); }
        $thead.appendChild(th);
      }
    }
    function renderResumen(rows){
      const statusCol=COLUMNS.find(c=>/estado|situacion|status/i.test(c));
      if(!statusCol){ $resumen.classList.add("hidden"); return; }
      const map=new Map(); for(const r of rows){ const k=String(r[statusCol]??""); map.set(k,(map.get(k)||0)+1); }
      const items=[...map.entries()].sort((a,b)=>b[1]-a[1]);
      const chips=items.map(([k,v])=>`<div class="px-3 py-2 rounded-xl border bg-slate-50"><div class="text-xs text-slate-500">${statusCol}</div><div class="font-semibold">${k||"(vacío)"} — ${v}</div></div>`).join("");
      $resumen.innerHTML=`<div class="flex flex-wrap gap-2">${chips}</div>`; $resumen.classList.remove("hidden");
    }
    function renderTableBody(rows){
      $tbody.innerHTML="";
      const start=(state.page-1)*state.pageSize, pageRows=rows.slice(start,start+state.pageSize);
      for(const r of pageRows){
        const tr=document.createElement("tr");
        for(const c of COLUMNS){
          const td=document.createElement("td"); td.className="px-3 py-2 border-b border-slate-100 align-top";
          const val=r[c]; let text=String(val??"");
          if(/alta|high|crítica|critica|urgente/i.test(text)) td.classList.add("bg-red-50");
          if(/media|medio/i.test(text)) td.classList.add("bg-yellow-50");
          if(/baja|low/i.test(text)) td.classList.add("bg-green-50");
          td.textContent=text; tr.appendChild(td);
        }
        $tbody.appendChild(tr);
      }
    }
    function render(){
      let rows=applyFilters(rawData); rows=applySort(rows);
      $countTotal.textContent=rawData.length; $countShown.textContent=rows.length;
      const totalPages=Math.max(1,Math.ceil(rows.length/state.pageSize));
      if(state.page>totalPages) state.page=totalPages;
      $pageNum.textContent=state.page; $pageTotal.textContent=totalPages;
      $prev.disabled=state.page<=1; $next.disabled=state.page>=totalPages;
      renderTableHeader(); renderResumen(rows); renderTableBody(rows);
      $btnExport.disabled = rows.length===0;
    }

    $q.addEventListener("input",e=>{ state.q=e.target.value; state.page=1; render(); });
    $col.addEventListener("change",e=>{ state.col=e.target.value; state.values=new Set(); state.page=1; renderValues(); render(); });
    $dateFrom.addEventListener("change",()=>{ state.page=1; render(); });
    $dateTo.addEventListener("change",()=>{ state.page=1; render(); });
    $btnClear.addEventListener("click",()=>{ state={ q:"", col:COLUMNS[0]||"", values:new Set(), sortCol:"", sortDir:1, page:1, pageSize:state.pageSize }; $q.value=""; $col.value=state.col; $dateFrom.value=""; $dateTo.value=""; renderValues(); render(); });
    $pageSize.addEventListener("change",e=>{ state.pageSize=parseInt(e.target.value,10); state.page=1; render(); });
    $prev.addEventListener("click",()=>{ if(state.page>1){ state.page--; render(); } });
    $next.addEventListener("click",()=>{ state.page++; render(); });

    function exportCSV(rows){
      const header=COLUMNS.join(",");
      const esc=v=>{ if(v==null) return ""; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s; };
      const lines=rows.map(r=>COLUMNS.map(c=>esc(r[c])).join(","));
      const csv=[header,...lines].join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="avisos_ot_filtrado.csv"; a.click(); URL.revokeObjectURL(url);
    }
    $btnExport.addEventListener("click",()=>{ let rows=applyFilters(rawData); rows=applySort(rows); exportCSV(rows); });

    // Drag & drop
    ["dragenter","dragover"].forEach(ev=> $drop.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.add("dragover"); }));
    ["dragleave","drop"].forEach(ev=> $drop.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); $drop.classList.remove("dragover"); }));
    $drop.addEventListener("drop",e=>{ if(e.dataTransfer.files && e.dataTransfer.files[0]) readFile(e.dataTransfer.files[0]); });

    $file.addEventListener("change",e=>{ const f=e.target.files[0]; if(f) readFile(f); });

    function readFile(file){
      const reader=new FileReader();
      reader.onload=(e)=>{
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:"array"});
        const sheetName = wb.SheetNames[0];
        const ws=wb.Sheets[sheetName];
        const json=XLSX.utils.sheet_to_json(ws,{defval:""});
        rawData=json;
        COLUMNS = json.length ? Object.keys(json[0]) : [];
        state.col = COLUMNS[0] || "";
        $loadInfo.textContent = `Hoja: ${sheetName} — Registros: ${rawData.length}`;
        renderColumnSelect();
        renderValues();
        // Fecha
        const dc = detectDateCol();
        $dateColName.textContent = dc ? `(${dc})` : "";
        // Habilitar export
        $btnExport.disabled = rawData.length === 0;
        render();
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
